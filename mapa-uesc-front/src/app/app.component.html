<div class="main-container">
  <!-- BOT√ÉO HAMB√öRGUER (quando menu fechado ‚Äì efeito visual s√≥ no mobile) -->
  @if (!menuAberto) {
    <button class="menu-btn" (click)="toggleMenu()">‚ò∞</button>
  }

  <!-- SIDEBAR -->
  <aside class="sidebar" [class.open]="menuAberto">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <h2>üìç Mapa UESC</h2>
        <p>Encontre pr√©dios, salas e setores do campus</p>
      </div>
      <button class="close-btn" (click)="toggleMenu()">‚úï</button>
    </div>

    <div class="search-box">
      <input
        type="text"
        placeholder="Digite sala (ex: 3201) ou nome do local..."
        [(ngModel)]="termoBusca"
        (input)="filtrarLocais()"
      />
    </div>

    <div class="sidebar-body">
      <!-- RESULTADO DA BUSCA POR SALA -->
      @if (salaBuscada) {
        <div class="sala-encontrada" (click)="abrirModalSala()">
          <div class="sala-badge">
            <span class="sala-icon">üö™</span>
            <div class="sala-info-text">
              <strong>{{ salaBuscada.sala }}</strong>
              <span>{{ salaBuscada.andar }}</span>
            </div>
          </div>
          <p class="sala-direcao">
            Localizada no <strong>Pavilh√£o {{ salaBuscada.pavilhao.nome.includes('Pedro') ? 'Pedro Calmon' : salaBuscada.pavilhao.nome.includes('Adonias') ? 'Adonias Filho' : 'Jorge Amado' }}</strong>
          </p>
          <span class="sala-hint">Clique para ver no mapa ‚Üí</span>
        </div>
      }

      @if (carregando) {
        <p class="status-msg">Carregando locais...</p>
      } @else if (erroCarregamento) {
        <p class="status-msg error">{{ erroCarregamento }}</p>
      } @else {
        <ul class="location-list">
          @for (local of locaisFiltrados; track local.id) {
            <li
              (click)="abrirModal(local)"
              [class.active]="localSelecionado?.id === local.id"
            >
              <strong>{{ local.nome }}</strong>
              <span class="location-subtitle">{{
                local.descricao || 'Local do campus'
              }}</span>
            </li>
          } @empty {
            <li class="status-msg">Nenhum local encontrado.</li>
          }
        </ul>
      }
    </div>
  </aside>

  <!-- √ÅREA DO MAPA -->
  <section class="map-area" (click)="menuAberto = false">
    <div class="map-container" (click)="capturarCoordenadas($event)">
      <img
        src="assets/mapa-base.png"
        alt="Mapa da UESC"
        class="mapa-imagem"
      />

      <!-- PINOS (usam lista filtrada) -->
      @for (local of locaisFiltrados; track local.id) {
        <button
          class="map-pin"
          [class.selected]="localSelecionado?.id === local.id"
          [style.left.%]="local.coordenadaX"
          [style.top.%]="local.coordenadaY"
          (click)="abrirModal(local, $event); $event.stopPropagation()"
          [attr.aria-label]="local.nome"
          title="{{ local.nome }}"
        >
          <span class="pin-dot"></span>
        </button>
      }

      <!-- MODAL FLUTUANTE -->
      @if (localSelecionadoVisivel) {
        <div
          class="modal-popup"
          [ngStyle]="posicaoModal"
          (click)="$event.stopPropagation()"
        >
          <div class="modal-header">
            <div class="modal-title">
              <h3>{{ localSelecionado!.nome }}</h3>
              <p class="modal-subtitle">
                {{
                  localSelecionado!.descricao || 'Local do campus da UESC'
                }}
              </p>
            </div>
            <button class="modal-close" (click)="fecharModal()">‚úï</button>
          </div>

          <div class="modal-tabs">
            <button
              [class.active]="abaAtual === 'foto'"
              (click)="mudarAba('foto')"
              title="Ver foto"
            >
              üì∑
            </button>
            <button
              [class.active]="abaAtual === 'salas'"
              (click)="mudarAba('salas')"
              title="Ver salas"
            >
              üö™
            </button>
            <button
              [class.active]="abaAtual === 'info'"
              (click)="mudarAba('info')"
              title="Informa√ß√µes"
            >
              ‚ÑπÔ∏è
            </button>
          </div>

          <div class="modal-content-body">
            <!-- FOTO -->
            @if (abaAtual === 'foto') {
              <div class="tab-foto fade-in">
                <img
                  [src]="'assets/' + localSelecionado!.urlImagem"
                  alt="Foto do local"
                  (error)="onErroImagem($event)"
                />
              </div>
            }

            <!-- SALAS -->
            @if (abaAtual === 'salas') {
              <div class="tab-salas fade-in">
                @if (getListaSalas().length > 0) {
                  <div class="salas-container">
                    @for (item of getListaSalas(); track $index) {
                      <div class="sala-row">
                        <div class="sala-andar">{{ item.andar }}</div>
                        <div class="sala-info">{{ item.salas }}</div>
                      </div>
                    }
                  </div>
                } @else {
                  <p class="empty-msg">Sem informa√ß√µes de salas.</p>
                }
              </div>
            }

            <!-- INFO -->
            @if (abaAtual === 'info') {
              <div class="tab-info fade-in">
                <p class="descricao-modal">
                  {{
                    localSelecionado!.descricao || 'Sem descri√ß√£o detalhada.'
                  }}
                </p>
                <hr />
                <small class="id-info">ID: {{ localSelecionado!.id }}</small>
              </div>
            }
          </div>

          <!-- BOT√ÉO COMO CHEGAR -->
          <div class="modal-footer">
            <button class="btn-rota" (click)="abrirRota(localSelecionado!)">
              üß≠ Como Chegar
            </button>
          </div>
        </div>
      }
    </div>
  </section>
</div>
