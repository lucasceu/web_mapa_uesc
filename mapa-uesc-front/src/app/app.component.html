<div class="main-container">
  
  @if (!menuAberto) {
    <button class="menu-btn" (click)="toggleMenu()">‚ò∞</button>
  }

  <aside class="sidebar" [class.open]="menuAberto">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <h2>üìç Mapa UESC</h2>
        <p>Campus Soane Nazar√©</p>
      </div>
      <button class="close-btn" (click)="toggleMenu()">‚úï</button>
    </div>

    <div class="search-box">
      <input 
        type="text" 
        placeholder="Buscar local ou sala..." 
        [(ngModel)]="termoBusca" 
        (input)="filtrarLocais()"
      >
    </div>

    <div class="sidebar-body">
      @if (salaBuscada) {
        <div class="sala-encontrada" (click)="abrirModalSala()">
          <div class="sala-badge">
            <span class="sala-icon">üö™</span>
            <div class="sala-info-text">
              <strong>{{ salaBuscada.sala }}</strong>
              <span>{{ salaBuscada.andar }}</span>
            </div>
          </div>
          <p class="sala-direcao">
            Localizada no <strong>{{ salaBuscada.pavilhao.nome }}</strong>
          </p>
          <span class="sala-hint">Clique para ver no mapa ‚Üí</span>
        </div>
      }

      <ul class="location-list">
        @for (local of locaisFiltrados; track local.id) {
          <li (click)="abrirModal(local)" [class.active]="localSelecionado?.id === local.id">
            <strong>{{ local.nome }}</strong>
            <span class="location-subtitle">{{ local.descricao }}</span>
          </li>
        }
      </ul>
    </div>
  </aside>

  <section class="map-area" (click)="menuAberto = false">
    <div class="map-container">
      
      <img src="assets/mapa-base.png" alt="Mapa UESC" class="mapa-imagem" (error)="onErroImagem($event)">

      <svg class="mapa-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
        @if (caminhoSVG) {
          <path [attr.d]="caminhoSVG" 
                fill="none" 
                stroke="#ef4444" 
                stroke-width="1.2" 
                stroke-dasharray="2" 
                class="rota-animada" />
        }
      </svg>

      @for (local of locaisFiltrados; track local.id) {
        <button
          class="map-pin"
          [class.selected]="localSelecionado?.id === local.id"
          [class.in-route]="isLocalNaRota(local)" 
          [style.left.%]="local.coordenadaX"
          [style.top.%]="local.coordenadaY"
          (click)="abrirModal(local, $event); $event.stopPropagation()"
          title="{{ local.nome }}"
        >
          <span class="pin-dot"></span>
        </button>
      }

      @if (localSelecionadoVisivel) {
        <div class="modal-popup" [ngStyle]="posicaoModal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <div class="modal-title">
              <h3>{{ localSelecionado!.nome }}</h3>
            </div>
            <button class="modal-close" (click)="fecharModal()">‚úï</button>
          </div>
          
          <div class="modal-tabs">
            <button [class.active]="abaAtual === 'foto'" (click)="mudarAba('foto')">üì∑</button>
            <button [class.active]="abaAtual === 'salas'" (click)="mudarAba('salas')">üö™</button>
            <button [class.active]="abaAtual === 'info'" (click)="mudarAba('info')">‚ÑπÔ∏è</button>
          </div>

          <div class="modal-content-body">
            @if (abaAtual === 'foto') {
              <div class="tab-foto fade-in">
                 <img [src]="'assets/' + localSelecionado!.urlImagem" (error)="onErroImagem($event)">
              </div>
            }

            @if (abaAtual === 'salas') {
              <div class="tab-salas fade-in">
                @for (item of getListaSalas(); track $index) {
                  <div class="sala-row">
                    <div class="sala-andar">{{ item.andar }}</div>
                    <div class="sala-info">{{ item.salas }}</div>
                  </div>
                }
                @if (getListaSalas().length === 0) {
                  <p class="empty-msg">Sem informa√ß√µes de salas.</p>
                }
              </div>
            }

            @if (abaAtual === 'info') {
              <div class="tab-info fade-in">
                <p class="descricao-modal">{{ localSelecionado!.descricao }}</p>
              </div>
            }
          </div>

          <div class="modal-footer">
            <button class="btn-rota" (click)="tracarRota(localSelecionado!)">
              üß≠ Tra√ßar Rota
            </button>
          </div>

        </div>
      }

    </div>
  </section>
</div>